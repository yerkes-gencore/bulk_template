---
title: "bulk_RNAseq_Analysis"
author: "DTG"
date:  "`r Sys.Date()`"
output: 
  rmdformats::robobook:
    fig_width: 9
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo=FALSE, fig.width = 6, fig.height = 4)
library(tidyverse)
library(ggforce)
library(grid)
library(ggpubr)
library(yaml)
library(DESeq2)
library(EDASeq)
library(DT)
library(shiny)
library(EnhancedVolcano)
library(tools)
library(ComplexHeatmap)
library(gridExtra)
library(gtable)
library(circlize)
library(openxlsx)
library(reshape2)
library(kableExtra)
library(rlang)
library(forcats)
library(gtools)
library(RColorBrewer)
library(fgsea)
library(MatrixGenerics)
#library(plyr)

counts <- DESeq2::counts
#config <- yaml.load_file("config.yaml")
source("functions.R")
```

<style type="text/css">
.book .book-body .page-inner {
  max-width: 1600px;
  margin-left: auto;
  margin-right: auto;
}
</style>

```{r}
analysis <- readRDS('analysis_post_QC.Rds')
analysis$ddsDrop <- DESeqDataSetFromMatrix(counts(analysis$ddsDrop),
                                           analysis$sampleTable,
                                           design = as.formula(paste0("~ ", analysis$config$design)))
analysis$ddsDrop <- DESeq(analysis$ddsDrop)
                                           
```

## DGE {.tabset}

```{r GSEA_setup}
## read GMT files
gmt.file <- list()
  for (a in file.path(analysis$config$rootDir, analysis$config$gseaFilesPath, analysis$config$gseaCollections)){#'mh.all.v0.3.symbols.gmt'
    gmt.file <- append(gmt.file, gmtPathways(file.path(a)))
  }
```

```{r run_comparisons}

### Add comparisons as you would pass them to a DESeq2::results contrast perameter E.g., 
### if you want a single existing contrast, pass it in as a string
### if you want to make a new contrast between factors, make it a list within the list

# resultsNames(analysis$ddsDrop)

  
my_comparisons <- list('Group_FAC_vs_Cont', 'Group_LiproxposFAC_vs_Cont', 'Group_MTposFAC_vs_Cont')

pairwise_comparisons <- function(x, alpha=0.05){
  ## Generate DESeq2 results objects for contrasts of interest
  if (class(x) == 'list'){
    result <- results(analysis$ddsDrop, contrast=x, test='Wald', alpha=alpha)
  } else if (class(x) == 'character'){
    result <- results(analysis$ddsDrop, name=x, test='Wald', alpha=alpha)
  }
  result@metadata$contrast <- paste0(x, collapse='_over_')
  return(result)
}

## Get DESeq2 results for each comparison of interest
results <- lapply(my_comparisons, pairwise_comparisons)
wb <- createWorkbook()
## Convert these result objects to custom class with visualizations, etc
## option to write out each result as an individual sheet in the workbook
results <- lapply(results, my_results_transform, wb, write_out=TRUE)

## Name result objects from contrasts
names(results) <- lapply(results, function(x) x@metadata$contrast)


## Write all results to workbook 
write_output_workbook(wb, results, analysis)
saveWorkbook(wb, file=paste0("outputs/",analysis$config$analysis, "_DESeq2_results.xlsx"), overwrite=T)
```

```{r prepare_results}
### you can add custom ggplot tracks to the outputs here, or edit datatables
### Input is the modifided DESeq2 object with the visualizations
output_results <- function(comp){
  # Just plaintext summary of the result object
  summary(results[[comp]])
  # Fixed window volcano plot
  volcanoPlot <- results[[comp]]@visualizations$volplot_fixed + labs(caption='Fixed window volcano plot, for comparing global trends across comparisons.')
  # Interactive datatable of all DGE results for this comp
  DGEtable <- DT::datatable(data.frame(results[[comp]]) %>% select(baseMean, log2FoldChange, lfcSE, padj) %>% filter(padj < analysis$config$alpha) %>% mutate_if(is.numeric, round, 4) %>% na.omit() %>% rownames_to_column(), rownames = FALSE, caption='DESeq2 output for this comparison, significant genes only', filter='top', autoHideNavigation = TRUE) 
  # Dotplot of top GSEA pathways
  gseaDotplot <- gsea_dotplot(results[[comp]]@gsea)
  # Interactive table of GSEA results
  gseaTable <- DT::datatable(head(results[[comp]]@gsea[order(results[[comp]]@gsea$pval)] %>% filter(size>10),1000) %>% select(pathway,pval,padj,ES,NES,size,), rownames = FALSE, filter='top', autoHideNavigation = TRUE, caption='GSEA enrichment results, top 1000') %>% formatRound(c('pval','padj', 'ES','NES'), digits=3)
  
  return(list(volcanoPlot=volcanoPlot,DGEtable=DGEtable,gseaDotplot=gseaDotplot,gseaTable=gseaTable))
}
```

### Comparison 1

```{r}
### call results outputs here with output_results(name_of_comparison)
### comparison names are based on the input lists earlier
comparison1 <- output_results(my_comparisons[[1]][[1]])
```

```{r, fig.height=8}
## kept separate to allow modified figure size
comparison1$volcanoPlot
```

```{r}
comparison1$DGEtable
```

```{r, fig.height=10}
comparison1$gseaDotplot
```

```{r}
comparison1$gseaTable
```

### Comparison 2 {.active}
<!-- You can make this the active tab instead of the first one if you want to highlight certain comp -->
```{r}
## Same as before with the next comparison. Repeat for however many comparisons you have
comparison2 <- output_results( my_comparisons[[1]][[2]])
```

```{r, fig.height=8}
comparison2$volcanoPlot
```

```{r}
comparison2$DGEtable
```

```{r, fig.height=10}
comparison2$gseaDotplot
```

```{r}
comparison2$gseaTable
```

## Genes of interest {.tabset}

These heatmaps show the relative expression (regularized and log2 transformed) of genes for each sample normalized to the baseline (mean expression for pre-treatment samples). Individual samples are grouped within their treatment/timepoint. Below the heatmaps are line plots of the same genes, tracking changes in normalized expression over time.

### Top genes from whole study

```{r, fig.width = 10, fig.height=5}
## creating an arbitrary genelist
top_genes <- data.frame(results(analysis$ddsDrop)) %>% filter(!is.na(pvalue)) %>% filter(abs(log2FoldChange)>log2(1.5))
top_genes <- top_genes[order(top_genes$pvalue),]
geneList <- (rownames(head(top_genes, 20)))

## Pass in a genelist
heatmap_from_genelist(geneList)
```

## GSEA

```{r}
A.fix <- as.data.frame(analysis$assayRlogForGSEA) %>% rownames_to_column('Name') %>% filter(!duplicated(Name)) %>% column_to_rownames('Name') %>% data.matrix() 
gene.labels <- rownames(A.fix)
sample.names <- colnames(A.fix)

phen_map <- as.factor(plyr::mapvalues(sample.names, from=analysis$ddsDrop@colData$SampleID, to=as.character(analysis$ddsDrop@colData$Group)))
```


```{r}
comp.num <-  'FAC'
comp.denom <- 'LiproxposFAC'
#sample.names[sample.phen=='FAC']
comp.ind <- c(grep(paste0('^',comp.num,'$'), sample.phen), grep(paste0('^',comp.denom,'$'), sample.phen))#sample.phen %in% comparison

  
  
O <- GSEA.GeneRanking(A[,comp.ind], as.integer(phen_map[comp.ind]), gene.labels, nperm = 1, permutation.type = 0, 
    sigma.correction = "GeneCluster", fraction = 1, replace = FALSE, 
    reverse.sign = FALSE, rank.metric = "S2N")
# order.matrix[, n.starts[nk]:n.ends[nk]] <- O$order.matrix
# obs.order.matrix[, n.starts[nk]:n.ends[nk]] <- O$obs.order.matrix
# correl.matrix[, n.starts[nk]:n.ends[nk]] <- O$rnk.matrix
# obs.correl.matrix[, n.starts[nk]:n.ends[nk]] <- O$obs.rnk.matrix
ranks <- O$obs.rnk.matrix[O$obs.order.matrix,]
```

```{r}
res <- fgseaSimple(pathways=gmt.file,
                   stats=ranks,
                   nperm=1000)
```

  